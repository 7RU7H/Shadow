#include "malware.h"
#include "GetModuleHandle.h"
#include "GetProcAddress.h"
#include "IATHook.h"

typedef void (*CreateFileW_T)(LPCWSTR, DWORD, DWORD, LPSECURITY_ATTRIBUTES, DWORD, DWORD, HANDLE);

CreateFileW_T CreateFileWOriginal = NULL;


void CreateFileWHook(
	_In_          LPCSTR                lpFileName,
	_In_           DWORD                 dwDesiredAccess,
	_In_          DWORD                 dwShareMode,
	_In_opt_ LPSECURITY_ATTRIBUTES lpSecurityAttributes,
	_In_           DWORD                 dwCreationDisposition,
	_In_           DWORD                 dwFlagsAndAttributes,
	_In_opt_ HANDLE                hTemplateFile
) {

	printf("CreateFileW Hooked! File path: %ws\n", lpFileName);
	printf("Calling Original CreatFileW!\n");
	CreateFileWOriginal(lpFileName, dwDesiredAccess, dwShareMode, lpSecurityAttributes, dwCreationDisposition, dwFlagsAndAttributes, hTemplateFile);
}

void RunMalware() {
	printf("Running Malware!\n");
	printf("CreateFileW Hooked!\n");
	CreateFileWOriginal = HookIAT(GetModuleHandleAReplacement(NULL), "Kernel32.dll", "CreateFileW", "CreateFileWHook");
	printf("CreateFileWOriginal address: 0x%p!\n", CreateFileWOriginal);
}